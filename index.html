<!DOCTYPE html>
<html>
<head>
    <title>ESCAPE NO.1 - Final Audit Edition</title>
    <style>
        body { text-align: center; background: #1a1a1a; color: white; font-family: 'Courier New', Courier, monospace; margin: 0; padding: 20px; }
        canvas { background: #f0f0f0; display: block; margin: 20px auto; border: 10px solid #333; cursor: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .menu { background: #333; padding: 20px; border-radius: 10px; display: inline-block; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; background: #ffcc00; font-weight: bold; margin: 5px; }
        button:hover { background: #ffa500; }
        .hidden { display: none; }
        .leaderboard { margin-top: 15px; text-align: left; font-size: 14px; color: #ffcc00; line-height: 1.6; }
    </style>
</head>
<body>
    <h1>ESCAPE NO.1</h1>
    
    <div id="start-screen" class="menu">
        <p>íƒˆì¶œí•  ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”!</p>
        <button onclick="window.startGame('worker1.png')">ê³µì£¼ (ë¶€í™œ)</button>
        <button onclick="window.startGame('worker2.png')">ì²­ì–‘ (ë¬´ì )</button>
        <button onclick="window.startGame('worker3.png')">ë…¼ì‚°ê³„ë£¡ (ë³´ë„ˆìŠ¤)</button>
        <div id="leaderboard" class="leaderboard">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <p style="font-size: 12px; color: #aaa; margin-top: 10px;">(Spaceë°”: ì²­ì–‘ ë¬´ì  ìŠ¤í‚¬ ì‚¬ìš©)</p>
    </div>

    <canvas id="gameCanvas" width="450" height="700" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, query, orderByChild, limitToLast } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuzD3SMZG_opARlCgKEbF4fVzvnuhPMKg",
            authDomain: "escapeone-fc10e.firebaseapp.com",
            databaseURL: "https://escapeone-fc10e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "escapeone-fc10e",
            storageBucket: "escapeone-fc10e.firebasestorage.app",
            messagingSenderId: "887833209533",
            appId: "1:887833209533:web:a674d2a8fa35f29efba5d4",
            measurementId: "G-GSRR230YTK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const leaderboardDiv = document.getElementById('leaderboard');

        let player = { x: 190, y: 600, w: 70, h: 70, img: new Image() };
        let targetX = 190;
        const easing = 0.12;
        
        let obstacles = [];
        let items = [];
        let floatingTexts = [];
        let score = 0;
        let gameActive = false;

        let hasExtraLife = false;
        let isInvincible = false;
        let canUseAbility = false;
        let itemBonusValue = 50;
        let shakeTime = 0;
        let bossTimer = 0;
        let currentBossType = "";
        let bossActive = false;
        let bossTriggers = [1000, 2000, 3000];

        const scoreRef = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(20));
        onValue(scoreRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const sorted = Object.values(data).sort((a, b) => b.score - a.score);
                let html = "<b>[ê¸€ë¡œë²Œ í•˜ë“œì›Œì»¤ Top 20 ê¸°ë¡]</b><br>";
                sorted.forEach((item, i) => {
                    html += `${i+1}ìœ„: ${item.username} - ${item.score}ì <br>`;
                });
                leaderboardDiv.innerHTML = html;
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (!gameActive) return;
            let rect = canvas.getBoundingClientRect();
            let mouseX = e.clientX - rect.left;
            targetX = Math.max(0, Math.min(mouseX - player.w / 2, canvas.width - player.w));
        });

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && canUseAbility && gameActive) {
                isInvincible = true;
                canUseAbility = false;
                floatingTexts.push({ x: player.x, y: player.y - 50, alpha: 1.0, text: "ğŸ›¡ï¸ ì²­ì–‘ê³ ì¶”íŒŒì›Œ ê°€ë™!" });
                setTimeout(() => { isInvincible = false; }, 2000);
            }
        });

        window.startGame = function(imgSrc) {
            player.img.src = imgSrc;
            hasExtraLife = imgSrc.includes('worker1.png');
            canUseAbility = imgSrc.includes('worker2.png');
            itemBonusValue = imgSrc.includes('worker3.png') ? 70 : 50;
            
            isInvincible = false;
            shakeTime = 0;
            bossActive = false;
            bossTimer = 0;
            bossTriggers = [1000, 2000, 3000];

            startScreen.classList.add('hidden');
            canvas.classList.remove('hidden');
            gameActive = true;
            score = 0;
            targetX = 190;
            player.x = 190;
            obstacles = [];
            items = [];
            floatingTexts = [];
            requestAnimationFrame(update);
        }

        function update() {
            if (!gameActive) return;

            ctx.save();
            if (shakeTime > 0) {
                ctx.translate(Math.random() * 14 - 7, Math.random() * 14 - 7);
                shakeTime--;
            }

            ctx.clearRect(-20, -20, canvas.width + 40, canvas.height + 40);

            ctx.strokeStyle = "#eee";
            for(let i=0; i<canvas.width; i+=50) { ctx.strokeRect(i, 0, 50, canvas.height); }

            player.x += (targetX - player.x) * easing;

            if (!isInvincible || Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.drawImage(player.img, player.x, player.y, player.w, player.h);
            }

            handleBoss();

            let px = player.x + player.w / 2;
            let py = player.y + player.h / 2;

            obstacles.forEach((obj, index) => {
                obj.y += 3 + (score / 500);
                ctx.drawImage(obj.img, obj.x, obj.y, obj.w, obj.h);

                if (!isInvincible && px > obj.x + 5 && px < obj.x + obj.w - 5 &&
                    py > obj.y + 5 && py < obj.y + obj.h - 5) {
                    
                    if (hasExtraLife) {
                        hasExtraLife = false;
                        obstacles = [];
                        shakeTime = 40;
                        floatingTexts.push({ x: player.x, y: player.y, alpha: 1.0, text: "ğŸ‘¸ ë¶€í™œ! ê³µì£¼ëŠ” ì£½ì§€ ì•Šì•„ìš”!" });
                    } else {
                        gameOver();
                    }
                }
                if (obj.y > canvas.height) { obstacles.splice(index, 1); score++; }
            });

            items.forEach((item, index) => {
                item.y += 3;
                ctx.drawImage(item.img, item.x, item.y, item.w, item.h);
                if (px > item.x && px < item.x + item.w && py > item.y && py < item.y + item.h) {
                    let gain = item.img.src.includes('money.png') ? itemBonusValue : 10;
                    score += gain;
                    floatingTexts.push({ x: item.x, y: item.y, alpha: 1.0, text: `+${gain}!` });
                    items.splice(index, 1);
                }
            });

            floatingTexts.forEach((ft, i) => {
                ctx.fillStyle = `rgba(255, 204, 0, ${ft.alpha})`;
                ctx.font = "bold 20px Courier New";
                ctx.fillText(ft.text, ft.x, ft.y);
                ft.y -= 1; ft.alpha -= 0.02;
                if (ft.alpha <= 0) floatingTexts.splice(i, 1);
            });

            spawnObstacle();
            spawnItem();
            
            ctx.fillStyle = "#333";
            ctx.font = "bold 20px Arial";
            ctx.fillText("ì—…ë¬´ëŸ‰: " + score, 20, 40);
            if (canUseAbility) ctx.fillText("[Space] ë¬´ì  ê°€ëŠ¥", 20, 70);

            ctx.restore();
            requestAnimationFrame(update);
        }

        function handleBoss() {
            bossTriggers.forEach((trigger, index) => {
                if (trigger !== -1 && score >= trigger && !bossActive) {
                    bossActive = true;
                    bossTimer = 600; 
                    if (index === 0) {
                        currentBossType = "ğŸ’¼ í–‰ì •ì‹¤ì¥ ì—…ë¬´ë– ë„˜ê¸°ê¸°!!";
                        shakeTime = 600; 
                    } else if (index === 1) {
                        currentBossType = "ğŸ« êµì¥ì„ ìƒë‹˜ ì‹¤ì—†ëŠ”ì†Œë¦¬!!";
                        shakeTime = 600; 
                    } else if (index === 2) {
                        currentBossType = "ğŸ§ ê°ì‚¬íŒ€ì˜ ì¦ë¹™ì„œë¥˜ ì œì¶œìš”êµ¬"; 
                        shakeTime = 800; 
                    }
                    bossTriggers[index] = -1;
                }
            });

            if (bossActive && bossTimer > 0) {
                bossTimer--;
                ctx.save();
                let isFinalBoss = score >= 3000;
                ctx.fillStyle = Math.floor(Date.now() / (isFinalBoss ? 100 : 200)) % 2 === 0 ? "red" : "orange";
                ctx.font = isFinalBoss ? "bold 32px Courier New" : "bold 28px Courier New";
                ctx.textAlign = "center";
                ctx.fillText(currentBossType, canvas.width/2, 120);
                
                ctx.font = "bold 16px Arial";
                ctx.fillText(`ë‚¨ì€ ì‹œê°„: ${Math.ceil(bossTimer/60)}ì´ˆ`, canvas.width/2, 150);
                
                // ë³´ìŠ¤ êµ¬ê°„ ê³µê²© íŒ¨í„´ ë³µêµ¬
                if (isFinalBoss) {
                    if (Math.random() < 0.25) spawnObstacle(); 
                    if (Math.random() < 0.1) {
                        floatingTexts.push({ 
                            x: Math.random() * canvas.width, 
                            y: 150 + Math.random() * 300, 
                            alpha: 1.5, 
                            text: "ğŸ“ ì„œë¥˜ ë³´ì™„!!" 
                        });
                    }
                } else {
                    // 1000ì , 2000ì  ë³´ìŠ¤ì¼ ë•Œ ì¥ì• ë¬¼ ìƒì„± ë¹ˆë„ ì¦ê°€
                    if (Math.random() < 0.18) spawnObstacle(); 
                }
                ctx.restore();

                if (bossTimer <= 0) {
                    bossActive = false;
                    currentBossType = "";
                    if (isFinalBoss) {
                        floatingTexts.push({ x: 100, y: 300, alpha: 2.0, text: "âœ¨ ê°ì‚¬ ê²°ê³¼ 'ì£¼ì˜' ì²˜ë¶„ìœ¼ë¡œ ë²„í‹°ê¸° ì„±ê³µ! âœ¨" });
                    }
                }
            }
        }

        function spawnObstacle() {
            let spawnChance = bossActive ? 0.15 : Math.min(0.12, 0.04 + (score / 1500));
            if (Math.random() < spawnChance) {
                const types = [{src:'laptop.png', s:50}, {src:'clock.png', s:45}, {src:'docs.png', s:50}];
                let t = types[Math.floor(Math.random() * types.length)];
                let obs = { x: Math.random()*(canvas.width-t.s), y: -t.s, w: t.s, h: t.s, img: new Image() };
                obs.img.src = t.src;
                obstacles.push(obs);
            }
        }

        function spawnItem() {
            if (Math.random() < 0.005) {
                let isMoney = Math.random() > 0.5;
                let item = { x: Math.random()*(canvas.width-50), y: -50, w: 50, h: 50, img: new Image() };
                item.img.src = isMoney ? 'money.png' : 'coffee.png';
                items.push(item);
            }
        }

        function gameOver() {
            gameActive = false;
            let msg = "";
            if (score >= 3000) msg = "âœ¨ ê°ì‚¬ ê²°ê³¼ 'ì£¼ì˜' ì²˜ë¶„ìœ¼ë¡œ ë²„í‹°ê¸° ì„±ê³µ! âœ¨";
            else if (score >= 1000) msg = "ğŸ”¥ ì „ì„¤ì˜ ì›Œì»¤í™€ë¦­! í•˜ì§€ë§Œ ê±´ê°•ì„ ìƒì—ˆìŠµë‹ˆë‹¤.";
            else if (score >= 500) msg = "ğŸ¢ ì˜¤ëŠ˜ ì—…ë¬´ë„ ê³ ìƒë§Œ í•˜ì…¨ìŠµë‹ˆë‹¤!";
            else if (score >= 100) msg = "ğŸ“ ê³„ì¥ë‹˜, ì´ ì„œë¥˜ ë‹¤ì‹œ í•´ì˜¤ì„¸ìš”.";
            else msg = "ğŸ£ ì„œê¸°ë³´ì”¨... ì˜¤ëŠ˜ ì ì‹¬ì€ í˜¼ì ë¨¹ì–´ë¼.";

            const name = prompt(`${msg}\nìµœì¢… ì ìˆ˜: ${score}\nì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`, "ìµëª…");
            if (name) {
                const newScoreRef = push(ref(db, 'leaderboard'));
                set(newScoreRef, { username: name, score: score, timestamp: Date.now() })
                .then(() => location.reload());
            } else {
                location.reload();
            }
        }
    </script>
</body>
</html>
