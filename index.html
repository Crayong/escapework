<!DOCTYPE html>
<html>
<head>
    <title>ESCAPE NO.1 - Notice Edition</title>
    <style>
        body { text-align: center; background: #1a1a1a; color: white; font-family: 'Courier New', Courier, monospace; margin: 0; padding: 20px; }
        canvas { background: #f0f0f0; display: block; margin: 20px auto; border: 10px solid #333; cursor: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .menu { background: #333; padding: 20px; border-radius: 10px; display: inline-block; width: 450px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; background: #ffcc00; font-weight: bold; margin: 5px; }
        button:hover { background: #ffa500; }
        .hidden { display: none; }
        
        /* ê³µì§€ì‚¬í•­ ìŠ¤íƒ€ì¼ */
        .notice-board { background: #444; color: #00ffcc; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px; border-left: 5px solid #00ffcc; text-align: left; }
        
        /* ë¦¬ë”ë³´ë“œ ìŠ¤í¬ë¡¤ ì œê±° */
        .leaderboard { margin-top: 15px; text-align: left; font-size: 14px; color: #ffcc00; line-height: 1.6; }
    </style>
</head>
<body>
    <h1>ESCAPE NO.1</h1>
    
    <div id="start-screen" class="menu">
        <div id="notice" class="notice-board">ğŸ“¢ ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

        <p>íƒˆì¶œí•  ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”!</p>
        <button onclick="window.startGame('worker1.png')">ê³µì£¼ (ë¶€í™œ)</button>
        <button onclick="window.startGame('worker2.png')">ì²­ì–‘ (ë¬´ì )</button>
        <button onclick="window.startGame('worker3.png')">ë…¼ì‚°ê³„ë£¡ (ë³´ë„ˆìŠ¤)</button>
        
        <div id="leaderboard" class="leaderboard">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <p style="font-size: 12px; color: #aaa; margin-top: 10px;">(Spaceë°”: ì²­ì–‘ ë¬´ì  ìŠ¤í‚¬ ì‚¬ìš©)</p>
    </div>

    <canvas id="gameCanvas" width="450" height="700" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, query, orderByChild, limitToLast } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuzD3SMZG_opARlCgKEbF4fVzvnuhPMKg",
            authDomain: "escapeone-fc10e.firebaseapp.com",
            databaseURL: "https://escapeone-fc10e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "escapeone-fc10e",
            storageBucket: "escapeone-fc10e.firebasedatabase.app",
            messagingSenderId: "887833209533",
            appId: "1:887833209533:web:a674d2a8fa35f29efba5d4",
            measurementId: "G-GSRR230YTK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const leaderboardDiv = document.getElementById('leaderboard');
        const noticeDiv = document.getElementById('notice');

        // --- ì‹¤ì‹œê°„ ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° ---
        const noticeRef = ref(db, 'notice');
        onValue(noticeRef, (snapshot) => {
            const msg = snapshot.val();
            noticeDiv.innerHTML = msg ? `ğŸ“¢ ê³µì§€: ${msg}` : "ğŸ“¢ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.";
        });

        // --- ë¦¬ë”ë³´ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ìŠ¤í¬ë¡¤ ì—†ì´ ì „ì²´ ì¶œë ¥) ---
        const scoreRef = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(20));
        onValue(scoreRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const sorted = Object.values(data).sort((a, b) => b.score - a.score);
                let html = "<b>[ê¸€ë¡œë²Œ í•˜ë“œì›Œì»¤ Top 20 ê¸°ë¡]</b><br>";
                sorted.forEach((item, i) => {
                    html += `${i+1}ìœ„: ${item.username} - ${item.score}ì <br>`;
                });
                leaderboardDiv.innerHTML = html;
            }
        });

        // ê²Œì„ ë³€ìˆ˜ ë° ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
        let player = { x: 190, y: 600, w: 70, h: 70, img: new Image() };
        let targetX = 190;
        const easing = 0.12;
        let obstacles = [], items = [], floatingTexts = [];
        let score = 0, gameActive = false, hasExtraLife = false, isInvincible = false, canUseAbility = false;
        let itemBonusValue = 50, shakeTime = 0, bossTimer = 0, currentBossType = "", bossActive = false;
        let bossTriggers = [1000, 2000, 3000];

        window.addEventListener('mousemove', (e) => {
            if (!gameActive) return;
            let rect = canvas.getBoundingClientRect();
            targetX = Math.max(0, Math.min(e.clientX - rect.left - player.w/2, canvas.width - player.w));
        });

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && canUseAbility && gameActive) {
                isInvincible = true; canUseAbility = false; shakeTime = 15;
                floatingTexts.push({ x: player.x, y: player.y - 50, alpha: 1.0, text: "ğŸ›¡ï¸ ì²­ì–‘ê³ ì¶”íŒŒì›Œ ê°€ë™!" });
                setTimeout(() => { isInvincible = false; }, 2000);
            }
        });

        window.startGame = function(imgSrc) {
            player.img.src = imgSrc;
            hasExtraLife = imgSrc.includes('worker1.png');
            canUseAbility = imgSrc.includes('worker2.png');
            itemBonusValue = imgSrc.includes('worker3.png') ? 70 : 50;
            isInvincible = false; shakeTime = 0; bossActive = false; bossTimer = 0;
            bossTriggers = [1000, 2000, 3000];
            startScreen.classList.add('hidden');
            canvas.classList.remove('hidden');
            gameActive = true; score = 0; targetX = 190; player.x = 190;
            obstacles = []; items = []; floatingTexts = [];
            requestAnimationFrame(update);
        }

        function update() {
            if (!gameActive) return;
            ctx.save();
            if (shakeTime > 0) {
                let mag = score >= 3000 ? 14 : 7;
                ctx.translate(Math.random()*mag-mag/2, Math.random()*mag-mag/2);
                shakeTime--;
            }
            ctx.clearRect(-50, -50, canvas.width+100, canvas.height+100);
            ctx.strokeStyle = "#eee";
            for(let i=0; i<canvas.width; i+=50) { ctx.strokeRect(i, 0, 50, canvas.height); }
            player.x += (targetX - player.x) * easing;
            if (!isInvincible || Math.floor(Date.now()/100)%2===0) ctx.drawImage(player.img, player.x, player.y, player.w, player.h);
            
            handleBoss();
            let px = player.x + player.w/2, py = player.y + player.h/2;

            obstacles.forEach((obj, i) => {
                obj.y += 3 + (score/500);
                ctx.drawImage(obj.img, obj.x, obj.y, obj.w, obj.h);
                if (!isInvincible && px > obj.x+5 && px < obj.x+obj.w-5 && py > obj.y+5 && py < obj.y+obj.h-5) {
                    if (hasExtraLife) { hasExtraLife = false; obstacles = []; shakeTime = 40; floatingTexts.push({x:player.x, y:player.y, alpha:1.0, text:"ğŸ‘¸ ë¶€í™œ!"}); }
                    else gameOver();
                }
                if (obj.y > canvas.height) { obstacles.splice(i,1); score++; }
            });

            items.forEach((item, i) => {
                item.y += 3; ctx.drawImage(item.img, item.x, item.y, item.w, item.h);
                if (px > item.x && px < item.x+item.w && py > item.y && py < item.y+item.h) {
                    let gain = item.img.src.includes('money.png') ? itemBonusValue : 10;
                    score += gain; floatingTexts.push({x:item.x, y:item.y, alpha:1.0, text:`+${gain}!`});
                    items.splice(i, 1);
                }
            });

            floatingTexts.forEach((ft, i) => {
                ctx.fillStyle = `rgba(255,204,0,${ft.alpha})`; ctx.font = "bold 20px Courier New";
                ctx.fillText(ft.text, ft.x, ft.y); ft.y -= 1; ft.alpha -= 0.02;
                if (ft.alpha <= 0) floatingTexts.splice(i, 1);
            });

            spawnObstacle(); spawnItem();
            ctx.fillStyle = "#333"; ctx.font = "bold 20px Arial"; ctx.textAlign = "left";
            ctx.fillText("ì—…ë¬´ëŸ‰: " + score, 20, 40);
            if (canUseAbility) ctx.fillText("[Space] ë¬´ì  ê°€ëŠ¥", 20, 70);
            ctx.restore();
            requestAnimationFrame(update);
        }

        function handleBoss() {
            bossTriggers.forEach((trig, i) => {
                if (trig !== -1 && score >= trig && !bossActive) {
                    bossActive = true; bossTimer = 600; shakeTime = 100;
                    if (i === 0) currentBossType = "ğŸ’¼ í–‰ì •ì‹¤ì¥ ì—…ë¬´ë– ë„˜ê¸°ê¸°!!";
                    else if (i === 1) currentBossType = "ğŸ« êµì¥ì„ ìƒë‹˜ ì‹¤ì—†ëŠ”ì†Œë¦¬!!";
                    else if (i === 2) { currentBossType = "ğŸ§ ê°ì‚¬íŒ€ ã€ì¦ë¹™ì„œë¥˜ã€ í˜‘ë°•"; shakeTime = 600; }
                    bossTriggers[i] = -1;
                }
            });
            if (bossActive && bossTimer > 0) {
                bossTimer--;
                ctx.fillStyle = Math.floor(Date.now()/(score>=3000?100:200))%2===0 ? "red" : "orange";
                ctx.font = "bold 24px Courier New"; ctx.textAlign = "center";
                ctx.fillText(currentBossType, canvas.width/2, 120);
                if (bossTimer <= 0) { bossActive = false; currentBossType = ""; }
            }
        }

        function spawnObstacle() {
            if (Math.random() < (bossActive ? 0.15 : Math.min(0.12, 0.04+(score/1500)))) {
                const types = [{src:'laptop.png', s:50}, {src:'clock.png', s:45}, {src:'docs.png', s:50}];
                let t = types[Math.floor(Math.random()*types.length)];
                let obs = { x: Math.random()*(canvas.width-t.s), y: -t.s, w: t.s, h: t.s, img: new Image() };
                obs.img.src = t.src; obstacles.push(obs);
            }
        }

        function spawnItem() {
            if (Math.random() < 0.005) {
                let item = { x: Math.random()*(canvas.width-50), y: -50, w: 50, h: 50, img: new Image() };
                item.img.src = Math.random() > 0.5 ? 'money.png' : 'coffee.png';
                items.push(item);
            }
        }

        function gameOver() {
            gameActive = false;
            setTimeout(() => {
                const name = prompt(`ìµœì¢… ì ìˆ˜: ${score}\nì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`, "ìµëª…");
                if (name) {
                    const newScoreRef = push(ref(db, 'leaderboard'));
                    set(newScoreRef, { username: name, score: score, timestamp: Date.now() }).then(() => location.reload());
                } else location.reload();
            }, 100);
        }
    </script>
</body>
</html>
