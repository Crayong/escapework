<!DOCTYPE html>
<html>
<head>
    <title>ESCAPE NO.1 - Notice Edition</title>
    <style>
        body { text-align: center; background: #1a1a1a; color: white; font-family: 'Courier New', Courier, monospace; margin: 0; padding: 20px; }
        canvas { background: #f0f0f0; display: block; margin: 20px auto; border: 10px solid #333; cursor: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .menu { background: #333; padding: 20px; border-radius: 10px; display: inline-block; width: 450px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; background: #ffcc00; font-weight: bold; margin: 5px; }
        button:hover { background: #ffa500; }
        .hidden { display: none; }
        
        /* ê³µì§€ì‚¬í•­ ìŠ¤íƒ€ì¼ */
        .notice-board { background: #444; color: #00ffcc; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px; border-left: 5px solid #00ffcc; text-align: left; }
        
        /* ë¦¬ë”ë³´ë“œ ìŠ¤í¬ë¡¤ ì œê±° */
        .leaderboard { margin-top: 15px; text-align: left; font-size: 14px; color: #ffcc00; line-height: 1.6; }
    </style>
</head>
<body>
    <h1>ESCAPE NO.1</h1>
    
    <div id="start-screen" class="menu">
        <div id="notice" class="notice-board">ğŸ“¢ ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

        <p>íƒˆì¶œí•  ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”!</p>
        <button onclick="window.startGame('worker1.png')">ê³µì£¼ (ê³µì£¼ë‹˜ë¶€í™œ)</button>
        <button onclick="window.startGame('worker2.png')">ì²­ì–‘ (ë¬´ì ì²­ì–‘ê¼¬ì¶”)</button>
        <button onclick="window.startGame('worker3.png')">ë…¼ì‚°ê³„ë£¡ (ë‹¬ê¸°ë³´ë„ˆì“°)</button>
        <button onclick="window.startGame('worker4.png')">ì²œì•ˆ (ì²œì•ˆí˜¸ë„ê³¼ì)</button>
        
        <div id="leaderboard" class="leaderboard">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <p style="font-size: 12px; color: #aaa; margin-top: 10px;">(ë§ˆìš°ìŠ¤ í´ë¦­: ì²­ì–‘ ë¬´ì  ìŠ¤í‚¬ ì‚¬ìš©)</p>
    </div>

    <canvas id="gameCanvas" width="450" height="700" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, query, orderByChild, limitToLast } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuzD3SMZG_opARlCgKEbF4fVzvnuhPMKg",
            authDomain: "escapeone-fc10e.firebaseapp.com",
            databaseURL: "https://escapeone-fc10e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "escapeone-fc10e",
            storageBucket: "escapeone-fc10e.firebasestorage.app",
            messagingSenderId: "887833209533",
            appId: "1:887833209533:web:a674d2a8fa35f29efba5d4",
            measurementId: "G-GSRR230YTK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const leaderboardDiv = document.getElementById('leaderboard');
        const noticeDiv = document.getElementById('notice');

        // --- ì‹¤ì‹œê°„ ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° ---
        const noticeRef = ref(db, 'notice');
        onValue(noticeRef, (snapshot) => {
            const msg = snapshot.val();
            noticeDiv.innerHTML = msg ? `ğŸ“¢ ê³µì§€: ${msg}` : "ğŸ“¢ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.";
        });

        // --- ë¦¬ë”ë³´ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ---
        const scoreRef = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(30));
        onValue(scoreRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const sorted = Object.values(data).sort((a, b) => b.score - a.score);
                let html = "<b>[ê¸€ë¡œë²Œ í•˜ë“œì›Œì»¤ Top 30 ê¸°ë¡]</b><br>";
                sorted.forEach((item, i) => {
                    html += `${i+1}ìœ„: ${item.username} - ${item.score}ì <br>`;
                });
                leaderboardDiv.innerHTML = html;
            }
        });

        // ê²Œì„ ë³€ìˆ˜ ë° ë¡œì§
        let player = { x: 190, y: 600, w: 70, h: 70, img: new Image() }; 
        let targetX = 190;
        const easing = 0.12;
        let obstacles = [], items = [], floatingTexts = [];
        let score = 0, gameActive = false, hasExtraLife = false, isInvincible = false, invincibleCount = 0; 
        let itemBonusValue = 50, shakeTime = 0, bossTimer = 0, currentBossType = "", bossActive = false;
        let bossTriggers = [1000, 2000, 3000];

        window.addEventListener('mousemove', (e) => {
            if (!gameActive) return;
            let rect = canvas.getBoundingClientRect();
            targetX = Math.max(0, Math.min(e.clientX - rect.left - player.w/2, canvas.width - player.w));
        });

        window.addEventListener('mousedown', (e) => {
            if (gameActive && invincibleCount > 0 && !isInvincible) {
                isInvincible = true; 
                invincibleCount--; 
                shakeTime = 15;
                floatingTexts.push({ x: player.x, y: player.y - 50, alpha: 1.0, text: `ğŸ›¡ï¸ ë¬´ì  ê°€ë™! (ë‚¨ì€ íšŸìˆ˜: ${invincibleCount})` });
                setTimeout(() => { isInvincible = false; }, 2000);
            }
        });

        window.startGame = function(imgSrc) {
            player.img.src = imgSrc;
            // ì²œì•ˆ ìºë¦­í„°(worker4) ì„ íƒ ì‹œ ì‚¬ì´ì¦ˆë¥¼ 30ìœ¼ë¡œ ì¤„ì„, ë‚˜ë¨¸ì§€ëŠ” 70
            player.w = imgSrc.includes('worker4.png') ? 30 : 80;
            player.h = imgSrc.includes('worker4.png') ? 30 : 80;
            // ì‘ì•„ì§„ ë§Œí¼ ë°”ë‹¥ ìœ„ì¹˜ ì¡°ì • (yì¶•)
            player.y = 700 - player.h - 30;

            hasExtraLife = imgSrc.includes('worker1.png');
            invincibleCount = imgSrc.includes('worker2.png') ? 2 : 0;
            itemBonusValue = imgSrc.includes('worker3.png') ? 100 : 50;
            isInvincible = false; shakeTime = 0; bossActive = false; bossTimer = 0;
            bossTriggers = [1000, 2000, 3000];
            startScreen.classList.add('hidden');
            canvas.classList.remove('hidden');
            gameActive = true; score = 0; targetX = 190; player.x = 190;
            obstacles = []; items = []; floatingTexts = [];
            requestAnimationFrame(update);
        }

        function update() {
            if (!gameActive) return;
            ctx.save();
            if (shakeTime > 0) {
                let mag = score >= 3000 ? 14 : 7;
                ctx.translate(Math.random()*mag-mag/2, Math.random()*mag-mag/2);
                shakeTime--;
            }
            ctx.clearRect(-50, -50, canvas.width+100, canvas.height+100);
            ctx.strokeStyle = "#eee";
            for(let i=0; i<canvas.width; i+=50) { ctx.strokeRect(i, 0, 50, canvas.height); }
            
            player.x += (targetX - player.x) * easing;
            if (!isInvincible || Math.floor(Date.now()/100)%2===0) ctx.drawImage(player.img, player.x, player.y, player.w, player.h);
            
            handleBoss();
            let px = player.x + player.w/2, py = player.y + player.h/2;

            obstacles.forEach((obj, i) => {
                obj.y += 3 + (score/500);
                ctx.drawImage(obj.img, obj.x, obj.y, obj.w, obj.h);
                
                // --- íŒì • ë¡œì§: ëª¨ë“  ìºë¦­í„°ê°€ ìê¸° ë©ì¹˜ë§Œí¼ ì •ì§í•˜ê²Œ íŒì • ë°›ìŒ ---
                // ìºë¦­í„°ì˜ ì¤‘ì‹¬ì (px, py) ê¸°ì¤€ìœ¼ë¡œ ê°ìì˜ ë„ˆë¹„/ë†’ì´ ì ˆë°˜ë§Œí¼ ë²”ìœ„ë¥¼ ì„¤ì •
                let hitW = player.w / 2 - 5; // ì•½ê°„ì˜ ì—¬ìœ (5px)ë§Œ ë‘ 
                let hitH = player.h / 2 - 5;
                
                if (!isInvincible && px > obj.x + 5 && px < obj.x + obj.w - 5 && 
                    py > obj.y + 5 && py < obj.y + obj.h - 5) {
                    
                    // ì •ë°€í•œ ì‚¬ê°í˜• ì¶©ëŒ íŒì •
                    if (Math.abs(px - (obj.x + obj.w/2)) < (hitW + obj.w/2) &&
                        Math.abs(py - (obj.y + obj.h/2)) < (hitH + obj.h/2)) {
                        if (hasExtraLife) { hasExtraLife = false; obstacles = []; shakeTime = 40; floatingTexts.push({x:player.x, y:player.y, alpha:1.0, text:"ğŸ‘¸ ë¶€í™œ!"}); }
                        else gameOver();
                    }
                }
                if (obj.y > canvas.height) { obstacles.splice(i,1); score++; }
            });

            items.forEach((item, i) => {
                item.y += 3; ctx.drawImage(item.img, item.x, item.y, item.w, item.h);
                if (px > item.x && px < item.x+item.w && py > item.y && py < item.y+item.h) {
                    let gain = item.img.src.includes('money.png') ? itemBonusValue : 10;
                    score += gain; floatingTexts.push({x:item.x, y:item.y, alpha:1.0, text:`+${gain}!`});
                    items.splice(i, 1);
                }
            });

            floatingTexts.forEach((ft, i) => {
                ctx.fillStyle = `rgba(255,204,0,${ft.alpha})`; ctx.font = "bold 20px Courier New";
                ctx.fillText(ft.text, ft.x, ft.y); ft.y -= 1; ft.alpha -= 0.02;
                if (ft.alpha <= 0) floatingTexts.splice(i, 1);
            });

            spawnObstacle(); spawnItem();
            ctx.fillStyle = "#333"; ctx.font = "bold 20px Arial"; ctx.textAlign = "left";
            ctx.fillText("ì—…ë¬´ëŸ‰: " + score, 20, 40);
            if (invincibleCount > 0) ctx.fillText(`í´ë¦­ìœ¼ë¡œ ë¬´ì  ê°€ëŠ¥: ${invincibleCount}íšŒ`, 20, 70);
            ctx.restore();
            requestAnimationFrame(update);
        }

        function handleBoss() {
            bossTriggers.forEach((trig, i) => {
                if (trig !== -1 && score >= trig && !bossActive) {
                    bossActive = true; bossTimer = 600; shakeTime = 400;
                    if (i === 0) currentBossType = "ğŸ’¼ í–‰ì •ì‹¤ì¥ ì—…ë¬´ë– ë„˜ê¸°ê¸°";
                    else if (i === 1) currentBossType = "ğŸ« êµì¥ì„ ìƒë‹˜ ì‹¤ì—†ëŠ”ì†Œë¦¬";
                    else if (i === 2) { currentBossType = "ğŸ§ ê°ì‚¬íŒ€ì˜ã€ì˜ìˆ˜ì¦íƒ€ë ¹ã€"; shakeTime = 800; }
                    bossTriggers[i] = -1;
                }
            });
            if (bossActive && bossTimer > 0) {
                bossTimer--;
                ctx.save();
                let isFinalBoss = score >= 3000;
                ctx.fillStyle = Math.floor(Date.now()/(isFinalBoss?100:200))%2===0 ? "red" : "orange";
                ctx.font = isFinalBoss ? "bold 32px Courier New" : "bold 24px Courier New"; ctx.textAlign = "center";
                ctx.fillText(currentBossType, canvas.width/2, 120);
                
                if (isFinalBoss) {
                    if (Math.random() < 0.25) spawnObstacle();
                    if (Math.random() < 0.1) {
                        floatingTexts.push({ x: Math.random() * canvas.width, y: 150 + Math.random() * 300, alpha: 1.5, text: "ğŸ“ ì„œë¥˜ ë³´ì™„!!" });
                    }
                } else {
                    if (Math.random() < 0.18) spawnObstacle();
                }
                ctx.restore();

                if (bossTimer <= 0) { 
                    bossActive = false; 
                    if (isFinalBoss) {
                        floatingTexts.push({ x: 50, y: 300, alpha: 2.5, text: "âœ¨ ê°ì‚¬ ê²°ê³¼ 'ì£¼ì˜' ì²˜ë¶„ìœ¼ë¡œ ë²„í‹°ê¸° ì„±ê³µ! âœ¨" });
                    }
                    currentBossType = ""; 
                }
            }
        }

        function spawnObstacle() {
            if (Math.random() < (bossActive ? 0.15 : Math.min(0.12, 0.04+(score/1500)))) {
                const types = [{src:'laptop.png', s:50}, {src:'clock.png', s:45}, {src:'docs.png', s:50}];
                let t = types[Math.floor(Math.random()*types.length)];
                let obs = { x: Math.random()*(canvas.width-t.s), y: -t.s, w: t.s, h: t.s, img: new Image() };
                obs.img.src = t.src; obstacles.push(obs);
            }
        }

        function spawnItem() {
            if (Math.random() < 0.005) {
                let item = { x: Math.random()*(canvas.width-50), y: -50, w: 50, h: 50, img: new Image() };
                item.img.src = Math.random() > 0.5 ? 'money.png' : 'coffee.png';
                items.push(item);
            }
        }

        function gameOver() {
            gameActive = false;
            setTimeout(() => {
                let msg = "";
                if (score >= 3000) msg = "âœ¨ ê°ì‚¬ ê²°ê³¼ 'ì£¼ì˜' ì²˜ë¶„ìœ¼ë¡œ ë²„í‹°ê¸° ì„±ê³µ! âœ¨";
                else if (score >= 1000) msg = "ğŸ”¥ ì „ì„¤ì˜ ì›Œì»¤í™€ë¦­! ê±´ê°•ì„ ìƒì—ˆìŠµë‹ˆë‹¤!";
                else if (score >= 500) msg = "ğŸ¢ ì˜¤ëŠ˜ ì—…ë¬´ë„ ì •ë§ ê³ ìƒë§Œ í•˜ì…¨ìŠµë‹ˆë‹¤!";
                else if (score >= 100) msg = "ğŸ“ ê³„ì¥ë‹˜, ì´ ì„œë¥˜ ë‹¤ì‹œ í•´ì˜¤ì„¸ìš”.";
                else msg = "ğŸ£ ì„œê¸°ë³´ì”¨... ì˜¤ëŠ˜ ì ì‹¬ì€ í˜¼ì ë¨¹ì–´ë¼.";

                const name = prompt(`${msg}\nìµœì¢… ì ìˆ˜: ${score}\nì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`, "ìµëª…");
                if (name) {
                    const newScoreRef = push(ref(db, 'leaderboard'));
                    set(newScoreRef, { username: name, score: score, timestamp: Date.now() }).then(() => location.reload());
                } else location.reload();
            }, 100);
        }
    </script>
</body>
</html>


