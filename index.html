<!DOCTYPE html><html><head>
    <title>ESCAPE NO.1 - Online Edition</title>
    <style>
        body { text-align: center; background: #1a1a1a; color: white; font-family: 'Courier New', Courier, monospace; margin: 0; padding: 20px; }
        canvas { background: #f0f0f0; display: block; margin: 20px auto; border: 10px solid #333; cursor: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .menu { background: #333; padding: 20px; border-radius: 10px; display: inline-block; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; background: #ffcc00; font-weight: bold; margin: 5px; }
        button:hover { background: #ffa500; }
        .hidden { display: none; }
        .leaderboard { margin-top: 15px; text-align: left; font-size: 14px; color: #ffcc00; line-height: 1.6; }
    </style></head><body>
    <h1>ESCAPE NO.1</h1>
    
    <div id="start-screen" class="menu">
        <p>ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”!</p>
        <button onclick="window.startGame('worker1.png')">ê³µì£¼</button>
        <button onclick="window.startGame('worker2.png')">ì²­ì–‘</button>
        <button onclick="window.startGame('worker3.png')">ë…¼ì‚°ê³„ë£¡</button>
        <div id="leaderboard" class="leaderboard">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <p style="font-size: 12px; color: #aaa; margin-top: 10px;">(ì»¤í”¼/ëˆì„ ë¨¹ìœ¼ë©´ 5ì´ˆê°„ ë¬´ì !)</p>
    </div>

    <canvas id="gameCanvas" width="450" height="700" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, query, orderByChild, limitToLast } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 1. Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCuzD3SMZG_opARlCgKEbF4fVzvnuhPMKg",
            authDomain: "escapeone-fc10e.firebaseapp.com",
            databaseURL: "https://escapeone-fc10e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "escapeone-fc10e",
            storageBucket: "escapeone-fc10e.firebasestorage.app",
            messagingSenderId: "887833209533",
            appId: "1:887833209533:web:a674d2a8fa35f29efba5d4",
            measurementId: "G-GSRR230YTK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 2. ê²Œì„ ë³€ìˆ˜ ì„¤ì •
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const leaderboardDiv = document.getElementById('leaderboard');

        let player = { x: 190, y: 600, w: 70, h: 70, img: new Image(), invincible: false };
        let obstacles = [];
        let items = [];
        let score = 0;
        let gameActive = false;

        // 3. ì˜¨ë¼ì¸ ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤ì‹œê°„)
        const scoreRef = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(20));
        onValue(scoreRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // FirebaseëŠ” ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ê°€ì ¸ì˜¤ë¯€ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í•„ìš”
                const sorted = Object.values(data).sort((a, b) => b.score - a.score);
                let html = "<b>[ê¸€ë¡œë²Œ í•˜ë“œì›Œì»¤ Top 20 ê¸°ë¡]</b><br>";
                sorted.forEach((item, i) => {
                    html += `${i+1}ìœ„: ${item.username} - ${item.score}ê°œ<br>`;
                });
                leaderboardDiv.innerHTML = html;
            } else {
                leaderboardDiv.innerHTML = "ì²« ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”!";
            }
        });

        // 4. ê²Œì„ í•¨ìˆ˜ë“¤ (window ê°ì²´ì— ë¶™ì—¬ì•¼ HTML ë²„íŠ¼ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)
        window.startGame = function(imgSrc) {
            player.img.src = imgSrc;
            startScreen.classList.add('hidden');
            canvas.classList.remove('hidden');
            gameActive = true;
            score = 0;
            obstacles = [];
            items = [];
            requestAnimationFrame(update);
        }

        function update() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ë°°ê²½ ê²©ì
            ctx.strokeStyle = "#eee";
            for(let i=0; i<canvas.width; i+=50) { ctx.strokeRect(i, 0, 50, canvas.height); }

            // ìºë¦­í„° ì´ë™ ì œí•œ
            canvas.onmousemove = (e) => {
                let rect = canvas.getBoundingClientRect();
                let tx = e.clientX - rect.left - player.w / 2;
                player.x = Math.max(0, Math.min(tx, canvas.width - player.w));
            };

            if (player.invincible) ctx.globalAlpha = Math.sin(Date.now()/100) * 0.5 + 0.5;
            ctx.drawImage(player.img, player.x, player.y, player.w, player.h);
            ctx.globalAlpha = 1.0;

            let px = player.x + player.w / 2;
            let py = player.y + player.h / 2;
            
            // --- ì•„ì£¼ ëŸ¬í”„í•œ íŒì • (shrinkAmount ì ìš©) ---
            let shrinkAmount = 18; 

            obstacles.forEach((obj, index) => {
                obj.y += 3 + (score / 200); 
                ctx.drawImage(obj.img, obj.x, obj.y, obj.w, obj.h);

                if (!player.invincible && 
                    px > obj.x + shrinkAmount && px < obj.x + obj.w - shrinkAmount &&
                    py > obj.y + shrinkAmount && py < obj.y + obj.h - shrinkAmount) {
                    gameOver();
                }

                if (obj.y > canvas.height) {
                    obstacles.splice(index, 1);
                    score++;
                }
            });

            // ì•„ì´í…œ ì—…ë°ì´íŠ¸
            items.forEach((item, index) => {
                item.y += 3;
                ctx.drawImage(item.img, item.x, item.y, item.w, item.h);
                if (px > item.x && px < item.x + item.w && py > item.y && py < item.y + item.h) {
                    items.splice(index, 1);
                    activateInvincible();
                }
            });

            spawnObstacle();
            spawnItem();
            
            ctx.fillStyle = "#333";
            ctx.font = "bold 20px Arial";
            ctx.fillText("í‡´ê·¼ê¹Œì§€ ë‚¨ì€ ì¼: " + score, 20, 40);
            if(player.invincible) {
                ctx.fillStyle = "red";
                ctx.fillText("ğŸ”¥ ì•¼ê·¼ ìˆ˜ë‹¹ íŒŒì›Œ!", 20, 70);
            }
            requestAnimationFrame(update);
        }

        function spawnObstacle() {
            let dynamicSpawnChance = Math.min(0.12, 0.04 + (score / 800));
            if (Math.random() < dynamicSpawnChance) {
                const types = [{ src: 'laptop.png', size: 50 }, { src: 'clock.png', size: 45 }, { src: 'docs.png', size: 50 }];
                let type = types[Math.floor(Math.random() * types.length)];
                let obs = { x: Math.random() * (canvas.width - type.size), y: -type.size, w: type.size, h: type.size, img: new Image() };
                obs.img.src = type.src;
                obstacles.push(obs);
            }
        }

        function spawnItem() {
            if (Math.random() < 0.003) {
                const itemTypes = ['coffee.png', 'money.png'];
                let item = { x: Math.random() * (canvas.width - 50), y: -50, w: 50, h: 50, img: new Image() };
                item.img.src = itemTypes[Math.floor(Math.random() * itemTypes.length)];
                items.push(item);
            }
        }

        function gameOver() {
            gameActive = false;
            const name = prompt("ì—…ë¬´ í­íƒ„! ìµœì¢… ì ìˆ˜: " + score + "\nì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "ìµëª…");
            if (name) {
                const newScoreRef = push(ref(db, 'leaderboard'));
                set(newScoreRef, { username: name, score: score, timestamp: Date.now() })
                .then(() => location.reload());
            } else {
                location.reload();
            }
        }

        function activateInvincible() {
            player.invincible = true;
            setTimeout(() => { player.invincible = false; }, 5000);
        }
    </script></body></html>